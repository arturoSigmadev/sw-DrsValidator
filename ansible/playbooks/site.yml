---
# DRS Validation Framework - Main Deployment Playbook
# Deploys complete solution to MiniPC

- name: "DRS Validation Framework - Complete Deployment"
  hosts: minipc
  become: true
  gather_facts: true
  serial: 1

  vars:
    deployment_timestamp: "{{ ansible_date_time.iso8601 }}"

  pre_tasks:
    - name: Display deployment information
      debug:
        msg: |
          ================================================
          🚀 DRS Validation Framework Deployment
          ================================================
          Target Host: {{ ansible_host }}
          Hardware: {{ hardware_type | default('generic') }}
          Timestamp: {{ deployment_timestamp }}
          Version: {{ app_version }}
          ================================================

    - name: Check connectivity to target host
      ping:
      register: connectivity_check

    - name: Verify sudo privileges
      command: id -u
      become: true
      register: sudo_check

  tasks:
    # Phase 1: System Preparation
    - name: "Phase 1: System Preparation and Updates"
      include_tasks: tasks/system-preparation.yml
      tags: [system, preparation]

    # Phase 3: Application Deployment
    - name: "Phase 3: DRS Application Deployment"
      include_tasks: tasks/app-deployment.yml
      tags: [app, deployment]

    # Phase 4: Monitoring and Backup Setup
    - name: "Phase 4: Monitoring and Backup Configuration"
      include_tasks: tasks/monitoring-setup.yml
      tags: [monitoring, backup]

    # Phase 5: Security Configuration
    - name: "Phase 5: Security Setup"
      include_tasks: tasks/security-setup.yml
      tags: [security]

  post_tasks:
    - name: Verify deployment success
      uri:
        url: "http://{{ ansible_host }}:{{ app_port }}/health"
        method: GET
        timeout: 30
      register: health_check
      retries: 5
      delay: 10
      until: health_check.status == 200

    - name: Display deployment summary
      debug:
        msg: |
          ================================================
          ✅ DRS Deployment Completed Successfully!
          ================================================
          🌐 Web Interface: http://{{ ansible_host }}:{{ app_port }}
          📊 Health Check: http://{{ ansible_host }}:{{ app_port }}/health
          📚 API Docs: http://{{ ansible_host }}:{{ app_port }}/docs
          ================================================
          📁 Installation Directory: {{ base_dir }}
          👤 Service User: {{ system_user }}
          🐳 Docker Container: {{ docker_container_name }}
          ================================================

  handlers:
    - name: restart docker
      systemd:
        name: docker
        state: restarted
        enabled: true

    - name: restart drs-service
      systemd:
        name: drs-validation
        state: restarted
        enabled: true

    - name: restart ssh
      systemd:
        name: ssh
        state: restarted
        enabled: true